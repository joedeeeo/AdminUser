<app-navbar></app-navbar>

<div class="user-table-container">

  <!-- Controls Grouped: Download, Search, Role -->
  <div class="controls-bar" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
    <button (click)="downloadExcel()">Download Excel</button>

    <!-- Search Bar -->
    <div class="search-bar" style="margin: 0;">
      <div class="search-wrapper">
        <i class="fas fa-search search-icon"></i>
        <input 
          type="text" 
          placeholder="Search by name or email..." 
          [(ngModel)]="searchQuery"
          (input)="onSearch()"
        />
      </div>
    </div>

    <!-- Role Filter -->
    <div class="role-filter">
      <label for="roleSelect">Role:</label>
      <select id="roleSelect" [(ngModel)]="selectedRole" (change)="loadUsers()">
        <option value="ADMIN">ADMIN</option>
        <option value="USER">USER</option>
      </select>
    </div>
  </div>

  <h2 class="table-title">All User</h2>
  <div class="table-wrapper">
    <table class="styled-table">
      <thead>
        <tr>
          <th>Sr.No</th>
          <th>Profile</th>
          <th>Name</th>
          <th>Email</th>
          <th>DOB</th>
          <th>Gender</th>
          <th>Contact</th>
          <th>Address</th>
          <th>CreatedDate</th>
          <th>ModifiedDate</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of users; index as i">
          <td>{{ i + 1 }}</td>
          <td>
            <div class="avatar-cell">
              <ng-container *ngIf="isValidBase64(user.profileImage); else initials">
                <img
                  [src]="'data:image/jpeg;base64,' + user.profileImage"
                  alt="Profile"
                  class="avatar-img"
                />
              </ng-container>
              <ng-template #initials>
                <div class="avatar-initials">
                  {{ getUserInitials(user.name) }}
                </div>
              </ng-template>
            </div>
          </td>
          <td>{{ user.name }}</td>
          <td>{{ user.email }}</td>
          <td>{{ user.dob }}</td>
          <td>{{ user.gender }}</td>
          <td>{{ user.contactNumber }}</td>
          <td>{{ user.address }}</td>
          <td>{{ user.formattedCreatedDate }}</td>
          <td>{{ user.formattedModifiedDate }}</td>
          <td>
            <div class="action-buttons">
              <button class="view-btn" (click)="viewProfile(user)">View</button>
              <button class="delete-btn" (click)="deleteUser(user.id)">Delete</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination Controls -->
  <div class="pagination-wrapper">
    <button (click)="prevPage()" [disabled]="page === 0">Prev</button>

    <button 
      *ngFor="let p of [].constructor(totalPages); let i = index"
      (click)="goToPage(i)"
      [class.active]="i === page">
      {{ i + 1 }}
    </button>

    <button (click)="nextPage()" [disabled]="page + 1 >= totalPages">Next</button>

    <div class="page-size-selector">
      <label for="size">Show:</label>
      <select id="size" [(ngModel)]="size" (change)="onPageSizeChange()">
        <option [value]="5">5</option>
        <option [value]="10">10</option>
        <option [value]="20">20</option>
        <option [value]="50">50</option>
      </select>
      <span>entries (Total: {{ totalElements }})</span>
    </div>
  </div>

</div>
